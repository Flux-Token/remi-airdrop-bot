<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REMI Airdrop Bot</title>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" crossorigin>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" crossorigin>
    <style>
        :root {
            --wallet-address-transparency: 0.1;
            --form-section-transparency: 0.1;
            --results-transparency: 0.1;
            --fee-confirmation-transparency: 0.9;
        }
    body {
        margin: 0;
        overflow-y: auto; /* Enable scrolling for the entire page */
        height: 100%; /* Ensure the body takes up the full height */
    }

    #page-wrapper {
        display: flex;
        flex-direction: column;
        min-height: 100vh; /* Ensure the page takes up at least the full viewport height */
    }

    #background-video {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: -2;
        pointer-events: none;
    }

    #preloader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease, visibility 0.5s ease;
        visibility: visible;
    }

    #preloader[style*="display: none"] {
        visibility: hidden;
    }

    .preloader-logo {
        font-family: 'Montserrat', sans-serif;
        font-size: 2.5em;
        font-weight: 700;
        letter-spacing: 2px;
        text-transform: uppercase;
        background: linear-gradient(90deg, #ff6f61, #ff00ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); text-shadow: 0 0 10px rgba(255, 111, 97, 0.5); }
        50% { transform: scale(1.1); text-shadow: 0 0 20px rgba(255, 111, 97, 0.8); }
        100% { transform: scale(1); text-shadow: 0 0 10px rgba(255, 111, 97, 0.5); }
    }

    .main-content {
        display: none;
        font-family: 'Montserrat', sans-serif;
        flex-direction: column;
        align-items: center;
        background: transparent;
        color: #fff;
        position: relative;
        padding-top: 60px;
        flex-grow: 1;
    }

    .main-content::-webkit-scrollbar {
        display: none;
    }

    header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        padding: 20px 0;
        text-align: center;
        background: transparent;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        z-index: 10;
    }

    header h1 {
        font-family: 'Montserrat', sans-serif;
        font-size: 2.2em;
        font-weight: 700;
        letter-spacing: 2px;
        text-transform: uppercase;
        background: linear-gradient(90deg, #ff6f61, #ff00ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: pulse 2s infinite;
        margin: 0;
    }

    .wallet-toggle {
        position: fixed;
        top: 24px;
        right: 20px;
        z-index: 11;
        font-size: 1.5em;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .wallet-toggle.disconnected {
        color: #6c757d;
    }

    .wallet-toggle.connected {
        color: #28a745;
    }

    .disconnect-button {
        position: fixed;
        top: 18px;
        right: 50px;
        z-index: 11;
        background: linear-gradient(90deg, #ff6f61, #ff00ff);
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-family: 'Montserrat', sans-serif;
        font-size: 0.8em;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(255, 111, 97, 0.4);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .disconnect-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 111, 97, 0.6);
    }

    #results p {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        padding: 10px;
        border-radius: 8px;
        margin: 5px 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: nowrap;
    }

    #results p .scanned-check {
        color: #28a745;
        font-size: 1.2em;
        margin-left: 10px;
    }

    #results p .copy-icon {
        color: #00d4ff;
        font-size: 1em;
        cursor: pointer;
        margin-right: 10px;
        transition: color 0.3s ease;
    }

    #results p .copy-icon:hover {
        color: #ff6f61;
    }

    .wallet-address-display {
        z-index: 1;
        margin: 0;
        font-family: 'Montserrat', sans-serif;
        font-size: 1em;
        font-weight: 500;
        color: #00d4ff;
        text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
        background: transparent;
        padding: 5px 10px;
        border-radius: 5px;
        display: none;
        text-align: center;
        white-space: nowrap;
    }

    .wallet-address-container {
        background: rgba(255, 255, 255, var(--wallet-address-transparency));
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        width: auto;
        max-width: 90%;
        margin-left: auto;
        margin-right: auto;
    }

    .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        max-width: 800px;
        width: 90%;
        margin: 0 auto;
        z-index: 1;
    }

    h2 {
        font-size: 1.5em;
        margin-bottom: 20px;
        font-weight: 600;
        color: #00d4ff;
        text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    button {
        background: linear-gradient(90deg, #ff6f61, #ff00ff);
        color: #fff;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        margin: 5px;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(255, 111, 97, 0.4);
        position: relative;
        overflow: hidden;
    }

    button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: 0.5s;
    }

    button:hover::before {
        left: 100%;
    }

    button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(255, 111, 97, 0.6);
    }

    button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    input, select {
        padding: 12px;
        margin: 10px 0;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 1em;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        width: 100%;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        display: block;
        box-sizing: border-box;
    }

    input:focus, select:focus {
        outline: none;
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        background: rgba(255, 255, 255, 0.2);
    }

    input::placeholder {
        color: #aaa;
    }

    .form-section {
        background: rgba(255, 255, 255, var(--form-section-transparency));
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 500px;
        box-sizing: border-box;
        margin-left: auto;
        margin-right: auto;
    }

    .form-section.login {
        margin: 0 auto;
        width: auto;
        max-width: 300px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 15px;
    }

    .form-section.login button {
        margin: 0;
    }

    .form-section.login #qr-link {
        text-align: center;
        width: 100%;
    }

    .form-section:not(.login) {
        width: 100%;
        max-width: 500px;
        align-items: center;
    }

    .button-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        width: 100%;
        margin-top: 10px;
    }

    .button-row button {
        flex: 1;
        min-width: 100px;
        max-width: 120px;
        padding: 10px 10px;
        font-size: 0.85em;
    }

    .wallet-input {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 15px;
        width: 100%;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        box-sizing: border-box;
        position: relative;
    }

    .wallet-input input.wallet-address {
        width: 100%;
        max-width: 400px;
        margin: 10px 0;
        box-sizing: border-box;
        padding: 12px 30px 12px 12px;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 1em;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        overflow-x: auto;
        white-space: nowrap;
    }

    .wallet-input .amount-remove-group {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
    }

    .wallet-input input.wallet-amount {
        width: 120px;
        max-width: 120px;
        margin: 0;
    }

    .wallet-input button {
        padding: 8px 15px;
        font-size: 0.9em;
        margin: 0;
    }

    .wallet-input .trustline-status-box {
        position: absolute;
        right: 10px;
        top: 22px;
        width: 16px;
        height: 16px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: transparent;
        border-radius: 3px;
        display: none;
    }

    .wallet-input .trustline-status-box.valid {
        background: #28a745;
        display: block;
    }

    .wallet-input .trustline-status-box.invalid {
        background: #dc3545;
        display: block;
    }

    .wallet-input .trustline-status-box.balance-only {
        background: #ffa500;
        display: block;
    }

    #footer-container {
        width: 100%;
        z-index: 1;
        margin-top: 30px;
    }

    footer {
        background: linear-gradient(90deg, #ff6f61, #ff00ff);
        padding: 15px 0;
        text-align: center;
        font-size: 0.9em;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    }

    footer a {
        color: #fff;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    footer a:hover {
        color: #00d4ff;
        text-decoration: underline;
    }

    #results p .status-sent {
        color: #28a745;
        font-weight: 600;
        margin-left: 10px;
    }

    #results p .status-failed {
        color: #dc3545;
        font-weight: 600;
        margin-left: 10px;
    }

    #results .export-csv-btn {
        background: linear-gradient(90deg, #ff6f61, #ff00ff);
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        margin: 10px auto;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(255, 111, 97, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    #results .export-csv-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(255, 111, 97, 0.6);
    }

    #results .export-csv-btn .icon {
margin-right: 8px;
    }
    @media (max-width: 600px) {
        .container {
            padding: 10px;
        }

        h1 {
            margin-top: 50px;
            font-size: 2em;
        }

        .wallet-input {
            max-width: 100%;
        }

        .wallet-input input.wallet-address {
            max-width: 100%;
            margin-bottom: 8px;
            padding: 10px 25px 10px 10px;
        }

        .wallet-input .amount-remove-group {
            gap: 3px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .wallet-input input.wallet-amount {
            margin-left: 0;
            margin-bottom: 8px;
            width: 80px;
            max-width: 80px;
        }

        .wallet-input button {
            margin-left: 0;
            padding: 6px 10px;
            font-size: 0.8em;
        }

        .wallet-input .trustline-status-box {
            right: 8px;
            top: 20px;
            width: 12px;
            height: 12px;
        }

        .notification, .fee-confirmation {
            padding: 8px 15px;
            font-size: 0.85em;
        }

        .wallet-address-display {
            font-size: 0.7em;
            max-width: 80%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 8px 12px;
        }

        .wallet-toggle {
            top: 12px;
            right: 8px;
            font-size: 1em;
        }

        .disconnect-button {
            top: 6px;
            right: 30px;
            font-size: 0.6em;
            padding: 3px 6px;
        }

        .form-section {
            max-width: 100%;
            padding: 15px;
        }

        .button-row {
            gap: 5px;
        }

        .button-row button {
            min-width: 70px;
            max-width: 90px;
            font-size: 0.7em;
            padding: 6px 6px;
            margin: 2px;
        }

        input, select {
            max-width: 100%;
            padding: 10px;
        }
    }

    #airdrop-form, #results {
        display: none;
        width: 100%;
    }

    #results {
        margin-top: 20px;
        text-align: left;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        background: rgba(255, 255, 255, var(--results-transparency));
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #results p {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        padding: 10px;
        border-radius: 8px;
        margin: 5px 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #results p .scanned-check {
        color: #28a745;
        font-size: 1.2em;
        margin-left: 10px;
    }

    .notification-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: none;
    }

    .notification {
        white-space: pre-line;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(90deg, #28a745, #00d4ff);
        color: #fff;
        padding: 15px 30px;
        border-radius: 8px;
        display: none;
        z-index: 10001;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        max-width: 80%;
        text-align: center;
        animation: fadeInOut 5s;
    }

    .notification.error {
        background: linear-gradient(90deg, #dc3545, #ff6f61);
    }

    .fee-confirmation {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, var(--fee-confirmation-transparency));
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        z-index: 10001;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: none;
        flex-direction: column;
        align-items: center;
        max-width: 80%;
        text-align: center;
        color: #fff;
        font-family: 'Montserrat', sans-serif;
    }

    .fee-confirmation p {
        font-size: 1em;
        margin: 0 0 15px;
        color: #00d4ff;
        text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);
    }

    .fee-confirmation .disclaimer {
        font-size: 0.8em;
        color: #aaa;
        margin: 10px 0;
    }

    .fee-confirmation .button-row {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .loader {
        display: none;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top: 4px solid #00d4ff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin: 0 10px;
    }

    #qr-code, .transaction-qr {
        display: none;
        margin: 20px auto;
        max-width: 200px;
        border: 5px solid #00d4ff;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
    }

    .qr-link {
        color: #00d4ff;
        text-decoration: none;
        font-size: 0.9em;
        margin-top: 10px;
        display: block;
        transition: all 0.3s ease;
        text-align: center;
    }

    .qr-link:hover {
        text-decoration: underline;
        color: #ff6f61;
    }

    .transaction-qr-link {
        text-align: center;
        display: block;
        width: 100%;
    }

    footer {
        background: linear-gradient(90deg, #ff6f61, #ff00ff);
        padding: 15px 0;
        text-align: center;
        font-size: 0.9em;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    }

    footer a {
        color: #fff;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    footer a:hover {
        color: #00d4ff;
        text-decoration: underline;
    }

    #results h2 {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #results .refresh-icon {
        color: #00d4ff;
        font-size: 1em;
        cursor: pointer;
        transition: color 0.3s ease, transform 0.3s ease;
    }

    #results .refresh-icon:hover {
        color: #ff6f61;
        transform: rotate(360deg);
    }

    #results .refresh-icon.spinning {
        animation: spin 1s linear infinite;
    }

    .wallet-balance {
margin-left: 10px;
font-size: 0.9em;
color: #888;

}

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes fadeInOut {
        0% { opacity: 0; transform: translate(-50%, -60%); }
        10% { opacity: 1; transform: translate(-50%, -50%); }
        90% { opacity: 1; transform: translate(-50%, -50%); }
        100% { opacity: 0; transform: translate(-50%, -60%); }
    }

    .icon {
        margin-right: 8px;
    }

    #check-trustline-btn.glow {
        animation: glow 1.5s ease-in-out infinite alternate;
        box-shadow: 0 0 15px rgba(255, 111, 97, 0.8), 0 0 25px rgba(255, 0, 255, 0.6);
    }

    @keyframes glow {
        from {
            box-shadow: 0 0 10px rgba(255, 111, 97, 0.5), 0 0 20px rgba(255, 0, 255, 0.4);
        }
        to {
            box-shadow: 0 0 20px rgba(255, 111, 97, 1), 0 0 30px rgba(255, 0, 255, 0.8);
        }
    }
</style>

</head>
<body>
    <video id="background-video" autoplay loop muted playsinline>
        <source src="https://video.wixstatic.com/video/15ad31_025323c53b36493482895d70f5acbd45/720p/mp4/file.mp4" type="video/mp4">
    </video>
    <div id="preloader">
        <div class="preloader-logo">REMI</div>
    </div>
    <!-- Wrapper for main content and footer -->
    <div id="page-wrapper">
        <div id="scroll-anchor" style="position: absolute; top: 0;"></div>
        <!-- Main content -->
        <div class="main-content">
            <button id="disconnect-button" class="disconnect-button" style="display: none;">Disconnect</button>
            <i id="wallet-toggle" class="fas fa-wallet wallet-toggle disconnected"></i>
            <header>
                <h1><i class="fas fa-rocket icon"></i> REMI Airdrop Bot</h1>
            </header>
            <div class="container">
                <div id="wallet-address-container" class="wallet-address-container" style="display: none;">
                    <div id="wallet-address-display" class="wallet-address-display"></div>
                </div>
                <div class="form-section login" style="display: none;">
                    <button id="login-btn"><i class="fas fa-sign-in-alt icon"></i> Log in with Xaman <span class="loader" id="login-loader"></span></button>
                    <img id="qr-code" src="" alt="QR Code for Login">
                    <a id="qr-link" class="qr-link" href="#" target="_blank" style="display: none;">Open in Xaman</a>
                </div>
                <div id="airdrop-form" class="form-section">
                    <select id="token-type">
                        <option value="XRP">XRP</option>
                    </select>
                    <input type="number" id="total-amount" placeholder="Calculated Total Airdrop Amount" step="0.000001" min="0" readonly>
                    <div id="wallet-list">
                        <div class="wallet-input">
                            <input type="text" class="wallet-address" placeholder="Wallet Address">
                            console.log('Adding wallet: address=', address, 'amount=', amount);
                            <div class="trustline-status-box"></div>
                            <div class="amount-remove-group">
                                <input type="number" class="wallet-amount" placeholder="Amount" step="0.000001" min="0">
                                <button onclick="removeWallet(this)">Remove</button>
                            </div>
                        </div>
                    </div>
                    <div class="button-row">
                        <button onclick="addWallet()"><i class="fas fa-plus icon"></i> Add Wallet</button>
                        <button id="check-balance-btn"><i class="fas fa-wallet icon"></i> Check Balance <span class="loader" id="balance-loader"></span></button>
                        <button id="validate-wallets-btn"><i class="fas fa-check-circle icon"></i> Validate Wallets <span class="loader" id="validate-loader"></span></button>
                        <button id="check-trustlines-btn"><i class="fas fa-link icon"></i> Check TrustLine <span class="loader" id="trustlines-loader"></span></button>
                        <button id="proceed-btn"><i class="fas fa-paper-plane icon"></i> Proceed to Signing <span class="loader" id="proceed-loader"></span></button>
                        <button id="csv-header-toggle"><i class="fas fa-table icon"></i> CSV Has Header: Yes</button>
                        <label for="csv-upload-input" class="button"><i class="fas fa-upload icon"></i> Upload CSV</label>
                        <input type="file" id="csv-upload-input" accept=".csv" style="display: none;">
                    </div>
                </div>
                <div id="transaction-signing" class="form-section" style="display: none;">
                    <h2 id="transaction-title"></h2>
                    <img class="transaction-qr" src="" alt="Transaction QR Code">
                    <a class="transaction-qr-link qr-link" href="#" target="_blank">Open in Xaman</a>
                </div>
                <div id="results" class="form-section">
                    <h2>Airdrop Report <i class="fas fa-sync-alt refresh-icon" onclick="refreshAirdropReport()"></i></h2>
                    <p>Total Network Fee: N/A XRP</p>
                    <p>Total REMI Service Fee: N/A XRP</p>
                    <button id="back-button" class="button">Back to Airdrop Form</button>
                </div>
            </div>
            <div id="notification-overlay" class="notification-overlay"></div>
            <div id="notification" class="notification"></div>
            <div id="fee-confirmation" class="fee-confirmation">
                <p id="fee-message"></p>
                <p class="disclaimer">Note: The fee is charged per wallet attempted, even if the transaction fails, to cover REMI's operational costs.</p>
                <div class="button-row">
                    <button id="fee-agree-btn"><i class="fas fa-check icon"></i> Agree</button>
                    <button id="fee-disagree-btn"><i class="fas fa-times icon"></i> Disagree</button>
                </div>
            </div>
            <div id="trustline-warning" class="fee-confirmation">
                <p id="trustline-warning-message"><span style="color: #dc3545;">Warning:</span> You’re sending to wallets flagged in RED for not having a mainnet trust line. You may proceed with the transaction, but we recommend checking each flagged wallet for a token balance first.</p>
                <div class="button-row">
                    <button id="trustline-agree-btn"><i class="fas fa-check icon"></i> Agree</button>
                    <button id="trustline-disagree-btn"><i class="fas fa-times icon"></i> Disagree</button>
                </div>
            </div>
        </div>
    <!-- Footer container -->
    <div id="footer-container" style="display: none;">
        <footer>
            <p>Powered by REMI | <a href="https://xrpl.org" target="_blank">Learn More</a></p>
        </footer>
    </div>
</div>
<audio id="loader-audio" src="https://static.wixstatic.com/mp3/15ad31_9eab52a3faee4738927cd3aed4e536d7.mp3" preload="auto" crossorigin="anonymous"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.3.1/decimal.min.js"></script>
<script>
    const PRELOADER_TIMEOUT = 6000;
    const BACKEND_URL = 'https://remi-airdrop-bot.onrender.com';
    let notificationTimeout = null;
    let trustlineChecked = false;

    function showMainContent() {
    const preloader = document.getElementById('preloader');
    const mainContent = document.querySelector('.main-content');
    const footerContainer = document.getElementById('footer-container');
    const loginSection = document.querySelector('.form-section.login');
    const airdropForm = document.getElementById('airdrop-form');
    const scrollAnchor = document.getElementById('scroll-anchor');

    preloader.style.opacity = '0';
    setTimeout(() => {
        preloader.style.display = 'none';
        mainContent.style.display = 'block';
        footerContainer.style.display = 'block';
        document.body.style.overflow = 'auto';
        const accessToken = getStorageItem('access_token');
        const storedAccount = getStorageItem('account');
        if (accessToken && storedAccount) {
            loginSection.style.display = 'none';
            airdropForm.style.display = 'block';
        } else {
            loginSection.style.display = 'block';
            airdropForm.style.display = 'none';
        }
        scrollAnchor.scrollIntoView({ behavior: 'instant', block: 'start' });
    }, 500);
}

function addWallet(address = '', amount = '') {
    const walletList = document.getElementById('wallet-list');
    const walletDiv = document.createElement('div');
    walletDiv.className = 'wallet-input';
    walletDiv.innerHTML = `
        <input type="text" class="wallet-address" placeholder="Wallet Address" value="${address}">
        <div class="trustline-status-box"></div>
        <div class="amount-remove-group">
            <input type="number" class="wallet-amount" placeholder="Amount" step="0.000001" min="0" value="${amount}">
            <button onclick="removeWallet(this)">Remove</button>
        </div>
    `;
    walletList.appendChild(walletDiv);
    updateTotalAmount();
}


document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing...');
    try {
        const audio = document.getElementById('loader-audio');
        audio.volume = 0.5;

        // Simplified audio playback logic with better error handling
        const playAudio = () => {
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.catch(err => {
                    console.warn('Audio playback failed:', err);
                    // Add a click handler to retry audio playback on user interaction
                    document.addEventListener('click', () => {
                        audio.play().catch(e => console.warn('Audio playback failed on click:', e));
                    }, { once: true });
                });
            }
        };
        playAudio();

        // Ensure the preloader timeout always executes, even if there are errors
        setTimeout(() => {
            console.log('Preloader timeout reached, forcing main content display...');
            showMainContent();
        }, PRELOADER_TIMEOUT);
    } catch (error) {
        console.error('Error in DOMContentLoaded event listener:', error);
        // Ensure the preloader is hidden even if an error occurs
        setTimeout(() => {
            console.log('Preloader timeout reached (error fallback), forcing main content display...');
            showMainContent();
        }, PRELOADER_TIMEOUT);
    }
});

        const loginBtn = document.getElementById('login-btn');
        const loginLoader = document.getElementById('login-loader');
        const qrCodeImg = document.getElementById('qr-code');
        const qrLink = document.getElementById('qr-link');
        const airdropForm = document.getElementById('airdrop-form');
        const loginSection = document.querySelector('.form-section.login');
        const transactionSigning = document.getElementById('transaction-signing');
        const transactionTitle = document.getElementById('transaction-title');
        const transactionQr = document.querySelector('.transaction-qr');
        const transactionQrLink = document.querySelector('.transaction-qr-link');
        const resultsDiv = document.getElementById('results');
        const notification = document.getElementById('notification');
        const notificationOverlay = document.getElementById('notification-overlay');
        const feeConfirmation = document.getElementById('fee-confirmation');
        const feeMessage = document.getElementById('fee-message');
        const feeAgreeBtn = document.getElementById('fee-agree-btn');
        const feeDisagreeBtn = document.getElementById('fee-disagree-btn');
        const tokenTypeSelect = document.getElementById('token-type');
        const totalAmountInput = document.getElementById('total-amount');
        const checkBalanceBtn = document.getElementById('check-balance-btn');
        const balanceLoader = document.getElementById('balance-loader');
        const validateWalletsBtn = document.getElementById('validate-wallets-btn');
        const validateLoader = document.getElementById('validate-loader');
        const checkTrustlinesBtn = document.getElementById('check-trustlines-btn');
        const trustlinesLoader = document.getElementById('trustlines-loader');
        const proceedBtn = document.getElementById('proceed-btn');
        const proceedLoader = document.getElementById('proceed-loader');
        const walletAddressDisplay = document.getElementById('wallet-address-display');
        const walletAddressContainer = document.getElementById('wallet-address-container');
        const walletToggle = document.getElementById('wallet-toggle');
        const disconnectButton = document.getElementById('disconnect-button');
        const scrollAnchor = document.getElementById('scroll-anchor');

        let storage = {};
        let tokenData = [];
        let transactionResults = [];
        let airdropData = { total_fee: null, service_fee: null };

        function getStorageItem(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                console.warn('localStorage access failed, using in-memory storage:', e);
                return storage[key] || null;
            }
        }

        function setStorageItem(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
                console.warn('localStorage set failed, using in-memory storage:', e);
                storage[key] = value;
            }
        }

        function removeStorageItem(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.warn('localStorage remove failed, updating in-memory storage:', e);
                delete storage[key];
            }
        }

        function decodeHexCurrency(hex) {
            if (!hex || typeof hex !== 'string' || hex.length !== 40 || !/^[0-9A-Fa-f]{40}$/.test(hex)) {
                return hex;
            }
            try {
                let result = '';
                for (let i = 0; i < hex.length; i += 2) {
                    const byte = parseInt(hex.substr(i, 2), 16);
                    if (byte === 0) break;
                    result += String.fromCharCode(byte);
                }
                return result || hex;
            } catch (e) {
                console.warn(`Failed to decode hex currency ${hex}:`, e);
                return hex;
            }
        }

        async function populateTokenDropdown() {
            console.log('Fetching token holdings...');
            try {
                const response = await fetch(`${BACKEND_URL}/get-tokens`, {
                    headers: {
                        'Authorization': `Bearer ${getStorageItem('access_token')}`,
                        'account': getStorageItem('account')
                    }
                });
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.detail || 'Unknown error'}`);
                }
                const data = await response.json();
                tokenData = data.tokens || [];
                console.log('Token holdings received:', tokenData);
                tokenTypeSelect.innerHTML = '<option value="XRP">XRP</option>';
                tokenData.forEach(token => {
                    console.log('Processing token:', token);
                    const option = document.createElement('option');
                    option.value = token.currency;
                    option.textContent = decodeHexCurrency(token.currency);
                    option.dataset.issuer = token.issuer;
                    option.dataset.currency = token.currency;
                    tokenTypeSelect.appendChild(option);
                });
                if (tokenData.length === 0) {
                    showNotification('No tokens found in your wallet. Airdrop XRP or add trustlines on Mainnet.', true);
                }
            } catch (error) {
                console.error('Error fetching tokens:', error);
                showNotification(
                    `Error fetching token holdings: ${error.message}. Ensure your account is funded on the XRP Ledger Mainnet. ` +
                    `Acquire XRP from an exchange like Coinbase or Bitstamp.`,
                    true
                );
            }
        }

        function clearTrustlineStatus() {
            const statusBoxes = document.querySelectorAll('.trustline-status-box');
            statusBoxes.forEach(box => {
                box.classList.remove('valid', 'invalid', 'balance-only');
                box.style.display = 'none';
            });
        }

        tokenTypeSelect.addEventListener('change', () => {
            console.log('Token type changed, clearing trustline status and amounts');
            clearTrustlineStatus();
            totalAmountInput.value = '';
            const walletInputs = document.getElementsByClassName('wallet-input');
            for (const input of walletInputs) {
                const amountInput = input.querySelector('.wallet-amount');
                amountInput.value = '';
            }
            updateTotalAmount();
        });

        const accessToken = getStorageItem('access_token');
        const storedAccount = getStorageItem('account');
        if (accessToken && storedAccount) {
            console.log('Validating existing access token...');
            fetch(`${BACKEND_URL}/balance`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'account': storedAccount
                }
            }).then(response => {
                if (response.status === 401) {
                    console.log('Access token invalid or expired');
                    handleUnauthorized();
                    return;
                } else if (response.status === 404) {
                    console.log('No XRPL account linked or not funded');
                    handleUnauthorized();
                    showNotification(
                        'No funded XRPL account linked in Xaman. Please create and fund an account on Mainnet at https://xrpl.org, ' +
                        'import it into Xaman, and sign in with it. Acquire XRP from an exchange like Coinbase or Bitstamp.',
                        true
                    );
                    return;
                } else if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            }).then(data => {
                if (data) {
                    console.log('Access token valid, showing airdrop form');
                    loginSection.style.display = 'none';
                    loginBtn.style.display = 'none';
                    qrCodeImg.style.display = 'none';
                    qrLink.style.display = 'none';
                    airdropForm.style.display = 'block';
                    checkBalanceBtn.disabled = false;
                    validateWalletsBtn.disabled = false;
                    checkTrustlinesBtn.disabled = false;
                    proceedBtn.disabled = false;
                    walletAddressDisplay.textContent = `Signed in as: ${storedAccount}`;
                    walletAddressContainer.style.display = 'block';
                    walletAddressDisplay.style.display = 'block';
                    walletToggle.classList.remove('disconnected');
                    walletToggle.classList.add('connected');
                    disconnectButton.style.display = 'inline-block';
                    populateTokenDropdown();
                    scrollAnchor.scrollIntoView({ behavior: 'instant', block: 'start' });
                }
            }).catch(error => {
                console.error('Error validating token:', error);
                handleUnauthorized();
                showNotification('Failed to validate session. Please log in again.', true);
            });
        } else {
            console.log('No access token or account found, showing login form');
            loginSection.style.display = 'block';
            loginBtn.style.display = 'block';
            airdropForm.style.display = 'none';
            qrCodeImg.style.display = 'none';
            qrLink.style.display = 'none';
            walletAddressContainer.style.display = 'none';
            walletAddressDisplay.style.display = 'none';
            walletToggle.classList.add('disconnected');
            walletToggle.classList.remove('connected');
            disconnectButton.style.display = 'none';
            scrollAnchor.scrollIntoView({ behavior: 'instant', block: 'start' });
        }

        walletToggle.addEventListener('click', () => {
            if (walletToggle.classList.contains('connected')) {
                handleSignOut();
            } else {
                loginBtn.click();
            }
        });

        disconnectButton.addEventListener('click', () => {
            console.log('Disconnect button clicked');
            handleSignOut();
        });

        function handleSignOut() {
            console.log('Signing out user...');
            handleUnauthorized();
            showNotification('Signed out successfully.');
            setTimeout(() => {
                console.log('Reloading page to restart bot...');
                window.location.reload();
            }, 500);
        }

        loginBtn.addEventListener('click', async () => {
            console.log('Login button clicked, calling /initiate-oauth...');
            loginBtn.disabled = true;
            loginLoader.style.display = 'inline-block';
            try {
                const response = await fetch(`${BACKEND_URL}/initiate-oauth`, { method: 'POST' });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.detail || 'Unknown error'}`);
                }
                const data = await response.json();
                console.log('Initiate-oauth response:', data);
                if (!data.payload_uuid || !data.qr_code_url || !data.authorize_url) {
                    throw new Error('Invalid OAuth initiation response');
                }
                setStorageItem('payload_uuid', data.payload_uuid);
                qrCodeImg.src = data.qr_code_url;
                qrCodeImg.style.display = 'block';
                qrLink.href = data.authorize_url;
                qrLink.style.display = 'block';
                showNotification('Please scan the QR code or click the link to log in with Xaman.');
                const signInWindow = window.open(data.authorize_url, '_blank');
                if (!signInWindow || signInWindow.closed || typeof signInWindow.closed === 'undefined') {
                    console.log('Pop-up blocked, QR code and link displayed.');
                    showNotification('Pop-up blocked. Please click the "Open in Xaman" link or scan the QR code.', true);
                }
                pollCallback(data.payload_uuid);
            } catch (error) {
                console.error('Error initiating login:', error);
                showNotification(`Error initiating login: ${error.message}`, true);
                loginBtn.disabled = false;
                loginLoader.style.display = 'none';
                qrCodeImg.style.display = 'none';
                qrLink.style.display = 'none';
            }
        });

        async function pollCallback(payloadUuid) {
            let attempts = 0;
            const maxAttempts = 48;
            const interval = setInterval(async () => {
                console.log(`Polling /callback (attempt ${attempts + 1}/${maxAttempts}) with payload_uuid:`, payloadUuid);
                try {
                    const response = await fetch(`${BACKEND_URL}/callback?payload_uuid=${payloadUuid}`, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    const data = await response.json();
                    console.log('Callback response:', { status: response.status, data });

                    if (response.status === 202 || data.status === "pending") {
                        attempts++;
                        if (attempts >= maxAttempts) {
                            clearInterval(interval);
                            showNotification('Login timed out', true);
                            loginBtn.disabled = false;
                            loginLoader.style.display = 'none';
                            qrCodeImg.style.display = 'none';
                            qrLink.style.display = 'none';
                        }
                    } else if (response.status === 400 && data.detail === "Payload was cancelled") {
                        clearInterval(interval);
                        showNotification('Login was cancelled', true);
                        loginBtn.disabled = false;
                        loginLoader.style.display = 'none';
                        qrCodeImg.style.display = 'none';
                        qrLink.style.display = 'none';
                    } else if (response.status === 400 && data.detail === "Payload has expired") {
                        clearInterval(interval);
                        showNotification('Login session expired', true);
                        loginBtn.disabled = false;
                        loginLoader.style.display = 'none';
                        qrCodeImg.style.display = 'none';
                        qrLink.style.display = 'none';
                    } else if (
                        response.status === 200 &&
                        data.meta && data.meta.signed &&
                        data.response && data.response.account &&
                        data.application && data.application.issued_user_token
                    ) {
                        clearInterval(interval);
                        setStorageItem('access_token', data.application.issued_user_token);
                        setStorageItem('account', data.response.account);
                        loginSection.style.display = 'none';
                        loginBtn.style.display = 'none';
                        qrCodeImg.style.display = 'none';
                        qrLink.style.display = 'none';
                        airdropForm.style.display = 'block';
                        checkBalanceBtn.disabled = false;
                        validateWalletsBtn.disabled = false;
                        checkTrustlinesBtn.disabled = false;
                        proceedBtn.disabled = false;
                        walletAddressDisplay.textContent = `Signed in as: ${data.response.account}`;
                        walletAddressContainer.style.display = 'block';
                        walletAddressDisplay.style.display = 'block';
                        walletToggle.classList.remove('disconnected');
                        walletToggle.classList.add('connected');
                        disconnectButton.style.display = 'inline-block';
                        showNotification('Login successful!');
                        populateTokenDropdown();
                    } else {
                        console.warn('Unexpected callback response:', JSON.stringify(data));
                        attempts++;
                        if (attempts >= maxAttempts) {
                            clearInterval(interval);
                            showNotification('Unexpected response from server. Please try again.', true);
                            loginBtn.disabled = false;
                            loginLoader.style.display = 'none';
                            qrCodeImg.style.display = 'none';
                            qrLink.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Error polling callback:', error);
                    attempts++;
                    if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        showNotification(`Error polling login status: ${error.message}. Please try again.`, true);
                        loginBtn.disabled = false;
                        loginLoader.style.display = 'none';
                        qrCodeImg.style.display = 'none';
                        qrLink.style.display = 'none';
                    }
                }
            }, 5000);
        }

        async function pollTransaction(payloadUuid, index, total, isFee = false) {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 48;
                const interval = setInterval(async () => {
                    console.log(`Polling /callback for ${isFee ? 'fee transaction' : `transaction ${index + 1}/${total}`} (attempt ${attempts + 1}/${maxAttempts}) with payload_uuid:`, payloadUuid);
                    try {
                        const response = await fetch(`${BACKEND_URL}/callback?payload_uuid=${payloadUuid}`);
                        const data = await response.json();
                        console.log('Callback response data:', JSON.stringify(data, null, 2));
                        if (response.status === 202 || data.status === "pending") {
                            attempts++;
                            if (attempts >= maxAttempts) {
                                clearInterval(interval);
                                showNotification(`${isFee ? 'Fee transaction' : `Transaction ${index + 1}/${total}`} timed out`, true);
                                resolve(false);
                            }
                        } else if (response.status === 400 && data.detail === "Payload was cancelled") {
                            clearInterval(interval);
                            showNotification(`${isFee ? 'Fee transaction' : `Transaction ${index + 1}/${total}`} was cancelled`, true);
                            resolve(false);
                        } else if (response.status === 400 && data.detail === "Payload has expired") {
                            clearInterval(interval);
                            showNotification(`${isFee ? 'Fee transaction' : `Transaction ${index + 1}/${total}`} session expired`, true);
                            resolve(false);
                        } else if (response.status === 200 && data.meta && data.meta.signed) {
                            clearInterval(interval);
                            showNotification(`${isFee ? 'Fee transaction' : `Transaction ${index + 1}/${total}`} signed successfully!`);
                            console.log(`Signed txid for payload ${payloadUuid}:`, data.response?.txid || 'None');
                            resolve(true);
                        } else {
                            throw new Error(`Unexpected callback response: ${JSON.stringify(data)}`);
                        }
                    } catch (error) {
                        console.error(`Error polling ${isFee ? 'fee transaction' : `transaction ${index + 1}/${total}`}:`, error);
                        clearInterval(interval);
                        showNotification(`Error polling ${isFee ? 'Fee transaction' : `transaction ${index + 1}/${total}`}: ${error.message}`, true);
                        resolve(false);
                    }
                }, 5000);
            });
        }

        window.addWallet = function() {
            const walletList = document.getElementById('wallet-list');
            const div = document.createElement('div');
            div.className = 'wallet-input';
            div.innerHTML = `
                <input type="text" class="wallet-address" placeholder="Wallet Address">
                <div class="trustline-status-box"></div>
                <div class="amount-remove-group">
                    <input type="number" class="wallet-amount" placeholder="Amount" step="0.000001" min="0">
                    <button onclick="removeWallet(this)">Remove</button>
                </div>
            `;
            walletList.appendChild(div);
            updateTotalAmount();
        };

        window.removeWallet = function(button) {
            button.parentElement.parentElement.remove();
            updateTotalAmount();
        };

        function updateTotalAmount() {
    const walletInputs = document.getElementsByClassName('wallet-input');
    let total = 0;
    let hasInvalid = false;
    for (const input of walletInputs) {
        const amountInput = input.querySelector('.wallet-amount');
        const addressInput = input.querySelector('.wallet-address');
        const amountValue = amountInput.value.trim();
        let amount = 0;
        if (amountValue) {
            amount = parseFloat(amountValue);
            if (isNaN(amount) || amount < 0) {
                amountInput.value = '';
                hasInvalid = true;
                amount = 0;
            }
        }
        console.log(`updateTotalAmount - Address: ${addressInput.value}, Amount: ${amountInput.value}, Parsed: ${amount}`);
        total += amount;
    }
    if (total === 0) {
        totalAmountInput.value = '';
    } else {
        totalAmountInput.value = total.toFixed(6);
    }
    if (hasInvalid) {
        showNotification('Invalid amounts were reset. Please enter valid numbers.', true);
    }
}

        document.getElementById('wallet-list').addEventListener('input', (event) => {
            if (event.target.classList.contains('wallet-amount')) {
                updateTotalAmount();
            }
        });

        function handleUnauthorized() {
            console.log('Clearing session data...');
            removeStorageItem('access_token');
            removeStorageItem('payload_uuid');
            removeStorageItem('account');
            loginSection.style.display = 'block';
            loginBtn.style.display = 'block';
            airdropForm.style.display = 'none';
            transactionSigning.style.display = 'none';
            feeConfirmation.style.display = 'none';
            resultsDiv.style.display = 'none';
            qrCodeImg.style.display = 'none';
            qrLink.style.display = 'none';
            walletAddressContainer.style.display = 'none';
            walletAddressDisplay.style.display = 'none';
            walletToggle.classList.remove('connected');
            walletToggle.classList.add('disconnected');
            disconnectButton.style.display = 'none';
            tokenTypeSelect.innerHTML = '<option value="XRP">XRP</option>';
            tokenData = [];
            showNotification('Session expired. Please log in again.', true);
        }

        checkBalanceBtn.addEventListener('click', async () => {
            console.log('Check Balance clicked, accessToken:', getStorageItem('access_token'));
            checkBalanceBtn.disabled = true;
            balanceLoader.style.display = 'inline-block';
            try {
                const tokenType = tokenTypeSelect.value;
                const selectedOption = tokenTypeSelect.selectedOptions[0];
                const issuer = selectedOption.dataset.issuer || '';
                const currency = selectedOption.dataset.currency || '';

                let query = '';
                if (tokenType !== 'XRP') {
                    if (!issuer || !currency) {
                        throw new Error('Issuer or currency missing for selected token');
                    }
                    if (!issuer.startsWith('r') || issuer.length < 25 || issuer.length > 35) {
                        throw new Error('Invalid issuer address for selected token');
                    }
                    query = `?issuer=${encodeURIComponent(issuer)}&currency=${encodeURIComponent(currency)}`;
                }

                console.log('Fetching balance with query:', query);
                const response = await fetch(`${BACKEND_URL}/balance${query}`, {
                    headers: {
                        'Authorization': `Bearer ${getStorageItem('access_token')}`,
                        'account': getStorageItem('account')
                    }
                });
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                if (response.status === 404) {
                    showNotification(
                        'No funded XRPL account linked in Xaman. Please create and fund an account on Mainnet at https://xrpl.org. ' +
                        'Acquire XRP from an exchange like Coinbase or Bitstamp.',
                        true
                    );
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.detail || 'Unknown error'}`);
                }
                const data = await response.json();
                console.log('Balance response:', data);

                const tokenName = tokenType === 'XRP' ? 'XRP' : decodeHexCurrency(tokenType);
                if (tokenType !== 'XRP') {
                    if (typeof data.balance_token !== 'undefined' && data.currency && data.account) {
                        showNotification(
                            `Total Available Balance: ${data.balance_token} ${tokenName} (Signed in as: ${data.account})`
                        );
                    } else {
                        console.warn('Invalid token balance response:', data);
                        showNotification(
                            `Unable to retrieve total balance for ${tokenName}. Ensure the account has a trustline for this token.`,
                            true
                        );
                    }
                } else {
                    if (data.balance_xrp && data.account) {
                        showNotification(
                            `Total Available Balance: ${data.balance_xrp} XRP (Signed in as: ${data.account})`
                        );
                    } else {
                        throw new Error('Invalid XRP balance response from server');
                    }
                }
            } catch (error) {
                console.error('Error checking balance:', error);
                showNotification(
                    `Error checking balance: ${error.message}. Ensure your account is funded and has a trustline for the token (if applicable) on Mainnet at https://xrpl.org. ` +
                    `Acquire XRP from an exchange like Coinbase or Bitstamp.`,
                    true
                );
            } finally {
                checkBalanceBtn.disabled = false;
                balanceLoader.style.display = 'none';
            }
        });

        validateWalletsBtn.addEventListener('click', async () => {
            console.log('Validate Wallets clicked, accessToken:', getStorageItem('access_token'));
            validateWalletsBtn.disabled = true;
            validateLoader.style.display = 'inline-block';
            try {
                const wallets = Array.from(document.getElementsByClassName('wallet-input')).map(div => {
                    const address = div.querySelector('.wallet-address').value.trim();
                    const amountInput = div.querySelector('.wallet-amount').value.trim();
                    if (!address) {
                        throw new Error('Wallet address cannot be empty');
                    }
                    const xrplAddressRegex = /^r[0-9a-zA-Z]{24,34}$/;
                    if (!xrplAddressRegex.test(address)) {
                        throw new Error(`Invalid XRPL address format: ${address}. Must start with 'r' and be 25-35 alphanumeric characters.`);
                    }
                    const amount = amountInput ? parseFloat(amountInput) : 0;
                    if (isNaN(amount) || amount < 0) {
                        throw new Error(`Invalid amount for address ${address}: ${amountInput}`);
                    }
                    return { address, amount };
                });
                if (wallets.length === 0) {
                    throw new Error('At least one wallet is required');
                }
                const tokenType = tokenTypeSelect.value;
                const selectedOption = tokenTypeSelect.selectedOptions[0];
                const issuer = selectedOption.dataset.issuer || '';
                const currency = selectedOption.dataset.currency || '';

                let query = `?token_type=${encodeURIComponent(tokenType)}`;
                if (tokenType !== 'XRP') {
                    if (!issuer || !currency) {
                        throw new Error('Issuer or currency missing for selected token');
                    }
                    query += `&issuer=${encodeURIComponent(issuer)}&currency=${encodeURIComponent(currency)}`;
                }

                console.log('Validating wallets:', wallets, 'Query:', query);
                const response = await fetch(`${BACKEND_URL}/validate-wallets${query}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getStorageItem('access_token')}`,
                        'account': getStorageItem('account')
                    },
                    body: JSON.stringify(wallets)
                });
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.detail || 'Unknown error'}`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error('Invalid validation response from server');
                }
                resultsDiv.innerHTML = '<h2>Wallet Validation Results</h2>' + data.map(wallet => `
                    <p>${wallet.address}: ${wallet.status}${wallet.error ? ` (${wallet.error})` : ''}</p>
                `).join('');
                resultsDiv.style.display = 'block';
                showNotification('Wallet validation completed!');
            } catch (error) {
                console.error('Error validating wallets:', error);
                showNotification(
                    `Error validating wallets: ${error.message}. Ensure addresses are valid on the XRP Ledger Mainnet. ` +
                    `Acquire XRP from an exchange like Coinbase or Bitstamp.`,
                    true
                );
            } finally {
                validateWalletsBtn.disabled = false;
                validateLoader.style.display = 'none';
            }
        });

        checkTrustlinesBtn.addEventListener('click', async () => {
console.log('Check Trustline clicked');
const wallets = Array.from(document.getElementsByClassName('wallet-input')).map(div => {
    const address = div.querySelector('.wallet-address').value.trim();
    const amountRaw = div.querySelector('.wallet-amount').value.trim();
    const amount = amountRaw === '' ? null : amountRaw;
    return { address, amount };
});

if (wallets.length === 0 || wallets.every(wallet => !wallet.address)) {
    console.log('Blocking: No valid wallet addresses provided');
    showNotification('Please add at least one wallet address to check trustlines.', true);
    return;
}

const tokenType = tokenTypeSelect.value;
const selectedOption = tokenTypeSelect.selectedOptions[0];
const issuer = selectedOption.dataset.issuer || '';
const currency = selectedOption.dataset.currency || '';

if (tokenType !== 'XRP' && (!issuer || !currency)) {
    console.log('Blocking: Invalid token selection (missing issuer or currency)');
    showNotification('Please select a valid token with issuer and currency.', true);
    return;
}

checkTrustlinesBtn.disabled = true;
trustlinesLoader.style.display = 'inline-block';

try {
    let query = `?token_type=${encodeURIComponent(tokenType)}`;
    if (tokenType !== 'XRP') {
        query += `&issuer=${encodeURIComponent(issuer)}&currency=${encodeURIComponent(currency)}`;
    }

    console.log('Checking trustlines with query:', query);
    console.log('Request body:', wallets);
    const response = await fetch(`${BACKEND_URL}/check-trustlines${query}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getStorageItem('access_token')}`,
            'account': getStorageItem('account')
        },
        body: JSON.stringify(wallets)
    });

    if (response.status === 401) {
        console.log('Unauthorized: Handling 401 error');
        handleUnauthorized();
        return;
    }
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        console.log('Trustline check failed:', errorData);
        throw new Error(`HTTP error! status: ${response.status} - ${JSON.stringify(errorData.detail || 'Unknown error')}`);
    }
    const data = await response.json();
    console.log('Trustline check response:', data);

    const walletInputs = document.getElementsByClassName('wallet-input');
    for (const input of walletInputs) {
        const address = input.querySelector('.wallet-address').value.trim();
        const trustlineResult = data.find(w => w.address === address);
        const statusBox = input.querySelector('.trustline-status-box');
        if (trustlineResult) {
            statusBox.classList.remove('valid', 'invalid');
            statusBox.classList.add(trustlineResult.has_trustline ? 'valid' : 'invalid');
            statusBox.style.display = 'block';
            console.log(`Updated wallet ${address}: hasTrustline=${trustlineResult.has_trustline}`);
        } else {
            statusBox.classList.remove('valid', 'invalid');
            statusBox.style.display = 'none';
            console.log(`Wallet ${address} not found in response, hiding status box`);
        }
    }

    trustlineChecked = true;
    checkTrustlinesBtn.classList.remove('glow');
    showNotification('Trustline check completed.');
    console.log('Trustline check completed, trustlineChecked set to true:', trustlineChecked);

    const allEligible = data.every(result => result.has_trustline);
    if (allEligible && data.length > 0) {
        showNotification('All wallets are eligible for airdrop (trustlines).', false);
    } else {
        showNotification(
            'Some wallets may be flagged RED but still be able to receive air drops due to known XPmarket and Xmagnetic trust line issues. Please verify before sending.',
            true
        );
    }
} catch (error) {
    console.error('Error checking trustlines:', error);
    showNotification(`Error checking trustlines: ${error.message}`, true);
} finally {
    checkTrustlinesBtn.disabled = false;
    trustlinesLoader.style.display = 'none';
}

});

async function fetchTransactionTxid(payloadUuid) {
    try {
        const response = await fetch(`${BACKEND_URL}/callback?payload_uuid=${payloadUuid}`);
        const data = await response.json();
        if (response.status === 200 && data.meta && data.meta.signed && data.response && data.response.txid) {
            return data.response.txid;
        }
        return null;
    } catch (error) {
        console.error(`Error fetching txid for payload ${payloadUuid}:`, error);
        return null;
    }
}

function exportAirdropResults(results, tokenType) {
    const csvContent = [
        'REMI Airdrop Results',
        'Transaction Number,Wallet Address,Token Amount,Transaction ID',
        ...results.map(result => 
            `${result.index},"${result.address}",${result.amount},"${result.txid || ''}"`
        )
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `REMI_Airdrop_Results_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    showNotification('Airdrop results exported as CSV.');
}

async function proceedWithAirdrop(wallets, tokenTypeSelect, serviceFee) {
    proceedBtn.disabled = true;
    proceedLoader.style.display = 'inline-block';
    airdropForm.style.display = 'none';
    resultsDiv.innerHTML = '';
    resultsDiv.style.display = 'none';
    transactionSigning.style.display = 'block';
    let transactionResults = []; // Store results for CSV export

try {
    const tokenType = tokenTypeSelect.value;
    const selectedOption = tokenTypeSelect.selectedOptions[0];
    const issuer = selectedOption.dataset.issuer || '';
    const currency = selectedOption.dataset.currency || '';
    const totalAmount = wallets.reduce((sum, wallet) => sum + (wallet.amount || 0), 0);
    const account = getStorageItem('account');

    let query = `?token_type=${encodeURIComponent(tokenType)}`;
    if (tokenType !== 'XRP') {
        query += `&issuer=${encodeURIComponent(issuer)}¤cy=${encodeURIComponent(currency)}`;
    }

    console.log('Fetching airdrop data with query:', query);
    const response = await fetch(`${BACKEND_URL}/airdrop${query}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getStorageItem('access_token')}`,
            'account': account
        },
        body: JSON.stringify({
            token_type: tokenType,
            total_amount: totalAmount,
            issuer: tokenType !== 'XRP' ? issuer : null,
            currency: tokenType !== 'XRP' ? currency : null,
            wallets: wallets,
            account: account
        })
    });

    if (response.status === 401) {
        handleUnauthorized();
        return;
    }
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(`HTTP error! status: ${response.status} - ${JSON.stringify(errorData.detail || 'Unknown error')}`);
    }
    const data = await response.json();
    console.log('Airdrop response:', data);

    if (data.fee_transaction) {
        transactionTitle.textContent = `Sign REMI Service Fee Payment (${serviceFee} XRP)`;
        transactionQr.src = `https://xumm.app/sign/${data.fee_transaction.payload_uuid}_q.png`;
        transactionQr.style.display = 'block';
        transactionQrLink.href = data.fee_transaction.sign_url;
        transactionQrLink.style.display = 'block';
        showNotification(`Please authorize the REMI Service Fee payment of ${serviceFee} XRP in Xaman.`);
        await new Promise(resolve => setTimeout(resolve, 1000));
        const feeSigned = await pollTransaction(data.fee_transaction.payload_uuid, 0, 0, true);
        if (!feeSigned) {
            showNotification('Fee payment not authorized. Airdrop cancelled.', true);
            proceedBtn.disabled = false;
            proceedLoader.style.display = 'none';
            transactionSigning.style.display = 'none';
            return;
        }
        console.log('Fee signed, proceeding to airdrop transactions');
    }

    let allSigned = true;
    if (!data.transactions || data.transactions.length === 0) {
        showNotification('No airdrop transactions generated. Check wallet data or server response.', true);
        proceedBtn.disabled = false;
        proceedLoader.style.display = 'none';
        transactionSigning.style.display = 'none';
        return;
    }

    const total = data.transactions.length;
    for (const [index, tx] of data.transactions.entries()) {
        if (!tx.status || !tx.status.address) {
            showNotification(`Transaction ${index + 1} has invalid status data`, true);
            allSigned = false;
            transactionResults.push({
                index: index + 1,
                address: tx.status?.address || 'Unknown',
                amount: wallets[index]?.amount || 0,
                txid: '',
                status: 'Failed',
                error: 'Invalid transaction data'
            });
            continue;
        }

        if (tx.status.status === 'Skipped' || tx.status.status === 'Failed') {
            transactionResults.push({
                index: index + 1,
                address: tx.status.address,
                amount: wallets[index]?.amount || 0,
                txid: '',
                status: 'Failed',
                error: tx.status.error || 'Transaction skipped or failed'
            });
            continue;
        }

        if (!tx.payload_uuid || !tx.sign_url) {
            showNotification(`Invalid transaction data for transaction ${index + 1}`, true);
            allyzallSigned = false;
            transactionResults.push({
                index: index + 1,
                address: tx.status.address,
                amount: wallets[index]?.amount || 0,
                txid: '',
                status: 'Failed',
                error: 'Missing payload or sign URL'
            });
            continue;
        }

        transactionTitle.textContent = `Sign Transaction ${index + 1} of ${total} (${tx.status.address})`;
        transactionTitle.setAttribute('title', tx.status.address);
        transactionQr.src = `https://xumm.app/sign/${tx.payload_uuid}_q.png`;
        transactionQr.style.display = 'block';
        transactionQrLink.href = tx.sign_url;
        transactionQrLink.style.display = 'block';
        showNotification(`Airdrop initiated. Please authorize transaction ${index + 1}/${total} in Xaman.`);
        await new Promise(resolve => setTimeout(resolve, 1000));
        const signed = await pollTransaction(tx.payload_uuid, index, total);
        const status = signed ? 'Sent' : 'Failed';
        const txid = signed ? (await fetchTransactionTxid(tx.payload_uuid)) || '' : '';
        transactionResults.push({
            index: index + 1,
            address: tx.status.address,
            amount: wallets[index]?.amount || 0,
            txid: txid,
            status: status,
            error: signed ? null : 'Transaction not signed'
        });
        if (!signed) {
            allSigned = false;
        }
    }

    // Hide transaction signing UI
    transactionSigning.style.display = 'none';
    transactionTitle.textContent = '';
    transactionQr.src = '';
    transactionQr.style.display = 'none';
    transactionQrLink.href = '#';
    transactionQrLink.style.display = 'none';

    // Display results
    if (allSigned) {
        showNotification('Airdrop transactions authorized successfully!');
    } else {
        showNotification('Some airdrop transactions failed or were not authorized.', true);
    }

    resultsDiv.innerHTML = `
        <h2>Airdrop Results <i class="fas fa-sync-alt refresh-icon" onclick="refreshAirdropReport()"></i></h2>
        ${transactionResults.map(result => `
            <p>
                Transaction ${result.index}: ${result.address} - ${result.amount} ${tokenType} 
                <span class="status-${result.status.toLowerCase()}">${result.status}</span>
                ${result.txid && result.status === 'Sent' ? `<a href="https://xrpscan.com/tx/${result.txid}" target="_blank" class="qr-link">View TX</a>` : ''}
                ${result.error ? `<span style="color: #dc3545;"> (${result.error})</span>` : ''}
            </p>
        `).join('')}
        <button id="export-csv-btn" class="export-csv-btn"><i class="fas fa-download icon"></i> Export CSV</button>
        <button id="back-button" class="button">Back to Airdrop Form</button>
    `;
    resultsDiv.style.display = 'block';

    // Attach event listeners
    const exportCsvBtn = document.getElementById('export-csv-btn');
    if (exportCsvBtn) {
        exportCsvBtn.addEventListener('click', () => exportAirdropResults(transactionResults, tokenType));
    }

    const newBackButton = document.getElementById('back-button');
    if (newBackButton) {
        console.log('Back button found, attaching event listener');
        newBackButton.addEventListener('click', () => {
            console.log('Back to Airdrop Form button clicked');
            clearForm();
        });
    } else {
        console.error('Back button not found after updating resultsDiv');
    }

} catch (error) {
    console.error('Error during airdrop:', error);
    showNotification(`Error during airdrop process: ${error.message}`, true);
    transactionSigning.style.display = 'none';
    transactionTitle.textContent = '';
    transactionQr.src = '';
    transactionQr.style.display = 'none';
    transactionQrLink.href = '#';
    transactionQrLink.style.display = 'none';
} finally {
    proceedBtn.disabled = false;
    proceedLoader.style.display = 'none';
}

}

    function showNotification(message, isError = false) {
        if (notificationTimeout) {
            clearTimeout(notificationTimeout);
            notification.style.display = 'none';
        }
        notification.textContent = message;
        notification.className = `notification ${isError ? 'error' : ''}`;
        notification.style.display = 'block';
        notificationTimeout = setTimeout(() => {
            notification.style.display = 'none';
            notificationTimeout = null;
        }, 5000);
    }

    function clearForm() {
        console.log('Clearing form and resetting UI...');
        const walletInputs = document.getElementsByClassName('wallet-input');
        while (walletInputs.length > 1) {
            walletInputs[walletInputs.length - 1].remove();
        }
        const firstWallet = walletInputs[0];
        if (firstWallet) {
            firstWallet.querySelector('.wallet-address').value = '';
            firstWallet.querySelector('.wallet-amount').value = '';
            const statusBox = firstWallet.querySelector('.trustline-status-box');
            statusBox.classList.remove('valid', 'invalid');
            statusBox.style.display = 'none';
        }
        totalAmountInput.value = '';
        tokenTypeSelect.value = 'XRP';
        resultsDiv.style.display = 'none';
        transactionSigning.style.display = 'none';
        feeConfirmation.style.display = 'none';
        notificationOverlay.style.display = 'none';
        const csvUploadInput = document.getElementById('csv-upload-input');
        csvUploadInput.value = '';
        if (loginSection.style.display === 'none') {
            const airdropFormElement = document.getElementById('airdrop-form');
            airdropFormElement.style.display = 'block';
            console.log('Airdrop form should now be visible, display style:', airdropFormElement.style.display);
            const container = airdropFormElement.closest('.container');
            if (container) {
                container.style.display = 'flex';
                console.log('Container display style:', container.style.display);
            }
        } else {
            loginSection.style.display = 'block';
            console.log('User not logged in, showing login section');
        }
    }

    let csvHasHeader = true;
    const csvHeaderToggle = document.getElementById('csv-header-toggle');
    csvHeaderToggle.addEventListener('click', () => {
        csvHasHeader = !csvHasHeader;
        csvHeaderToggle.textContent = `CSV Has Header: ${csvHasHeader ? 'Yes' : 'No'}`;
        console.log('CSV header toggle set to:', csvHasHeader);
    });

    const csvUploadInput = document.getElementById('csv-upload-input');
    csvUploadInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) {
        showNotification('No file selected.', true);
        return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
        console.log('Adding wallet: address=', address, 'amount=', amount);
        const text = event.target.result;
        const rows = text.split('\n').filter(row => row.trim() !== '');
        const wallets = [];
        let hasInvalid = false;

        rows.forEach((row, index) => {
            const cols = row.split(',').map(col => col.trim());
            // Skip header rows or rows with insufficient columns
            if (cols.length < 2 || cols[0].startsWith('(')) {
                console.log(`Skipping row ${index}: ${row}`);
                return;
            }

            const address = cols[0];
            const amount = cols[1];
            let numericAmount = parseFloat(amount);

            // Validate address format (basic check)
            if (!address || !address.startsWith('r') || address.length < 25 || address.length > 35) {
                console.log(`Invalid address at row ${index}: ${address}`);
                hasInvalid = true;
                return;
            }

            // Validate amount
            if (isNaN(numericAmount) || numericAmount <= 0) {
                console.log(`Invalid amount at row ${index}: ${amount}`);
                hasInvalid = true;
                return;
            }

            // Store amount as a string to match addWallet's expectation
            wallets.push({ address, amount: numericAmount.toString() });
        });

        if (hasInvalid) {
            showNotification('Some rows contain invalid data and were skipped. Please check the CSV format.', true);
        }

        if (wallets.length === 0) {
            showNotification('No valid wallets found in the CSV.', true);
            return;
        }

        const walletList = document.getElementById('wallet-list');
        walletList.innerHTML = '';
        wallets.forEach((wallet, index) => {
            const safeAddress = wallet.address || '';
            const safeAmount = wallet.amount || '';
            console.log(`Adding wallet ${index}: address=${safeAddress}, amount=${safeAmount}, type of amount=${typeof safeAmount}`);
            addWallet(safeAddress, safeAmount);
        });

        walletList.style.display = 'block';
        walletList.offsetHeight;
        console.log('Before updateTotalAmount delay - Checking DOM values:');
        document.querySelectorAll('.wallet-input').forEach((input, idx) => {
            const addr = input.querySelector('.wallet-address').value;
            const amt = input.querySelector('.wallet-amount').value;
            console.log(`Wallet ${idx}: address=${addr}, amount=${amt}`);
        });

        setTimeout(() => {
            console.log('After delay, before updateTotalAmount - Checking DOM values:');
            document.querySelectorAll('.wallet-input').forEach((input, idx) => {
                const addr = input.querySelector('.wallet-address').value;
                const amt = input.querySelector('.wallet-amount').value;
                console.log(`Wallet ${idx}: address=${addr}, amount=${amt}`);
            });

            updateTotalAmount();

            console.log('After updateTotalAmount - Checking DOM values:');
            document.querySelectorAll('.wallet-input').forEach((input, idx) => {
                const addr = input.querySelector('.wallet-address').value;
                const amt = input.querySelector('.wallet-amount').value;
                console.log(`Wallet ${idx}: address=${addr}, amount=${amt}`);
            });

            showNotification(`Successfully loaded ${wallets.length} wallets from CSV.`);

            // Temporarily disable checkTrustlines to isolate the issue
            // checkTrustlines();

            // Log values after all operations
            console.log('Final state after all operations - Checking DOM values:');
            document.querySelectorAll('.wallet-input').forEach((input, idx) => {
                const addr = input.querySelector('.wallet-address').value;
                const amt = input.querySelector('.wallet-amount').value;
                console.log(`Wallet ${idx}: address=${addr}, amount=${amt}`);
            });
        }, 500);

        // Reset the input value to allow re-uploading the same file
        csvUploadInput.value = '';
    };

    reader.onerror = () => {
        showNotification('Error reading CSV file. It may be corrupted or not accessible.', true);
    };
    reader.readAsText(file);
});

// Ensure the next event listener is syntactically correct
tokenTypeSelect.addEventListener('change', () => {
    trustlineChecked = false;
    checkTrustlinesBtn.classList.add('glow');
});

    window.refreshAirdropReport = function() {
        console.log('Refreshing airdrop report...');
        const refreshIcon = document.querySelector('.refresh-icon');
        refreshIcon.classList.add('spinning');
        setTimeout(() => {
            refreshIcon.classList.remove('spinning');
            showNotification('Airdrop report refreshed.');
        }, 1000);
    };
</script>

</body>
</html>

